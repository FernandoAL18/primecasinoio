"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Transaction = void 0;
const sdk_core_1 = require("@bitgo/sdk-core");
const iface_1 = require("./iface");
const utils_1 = __importStar(require("./utils"));
const types_1 = require("./mystenlab/types");
const constants_1 = require("./constants");
const buffer_1 = require("buffer");
const bcs_1 = require("@mysten/bcs");
const bs58_1 = __importDefault(require("bs58"));
const TransactionDataBlock_1 = require("./mystenlab/builder/TransactionDataBlock");
const builder_1 = require("./mystenlab/builder");
const blake2b_1 = __importDefault(require("@bitgo/blake2b"));
const hash_1 = require("./mystenlab/cryptography/hash");
class Transaction extends sdk_core_1.BaseTransaction {
    constructor(_coinConfig) {
        super(_coinConfig);
    }
    get suiTransaction() {
        return this._suiTransaction;
    }
    setSuiTransaction(tx) {
        this._suiTransaction = tx;
    }
    /** @inheritDoc **/
    get id() {
        const dataBytes = this.getDataBytes();
        const hash = (0, hash_1.hashTypedData)('TransactionData', dataBytes);
        this._id = bs58_1.default.encode(hash);
        return this._id;
    }
    addSignature(publicKey, signature) {
        this._signatures.push(signature.toString('hex'));
        this._signature = { publicKey, signature };
        this.serialize();
    }
    get suiSignature() {
        return this._signature;
    }
    get serializedSig() {
        return this._serializedSig;
    }
    setSerializedSig(publicKey, signature) {
        const pubKey = buffer_1.Buffer.from(publicKey.pub, 'hex');
        const serialized_sig = new Uint8Array(1 + signature.length + pubKey.length);
        serialized_sig.set(constants_1.SIGNATURE_SCHEME_BYTES);
        serialized_sig.set(signature, 1);
        serialized_sig.set(pubKey, 1 + signature.length);
        this._serializedSig = serialized_sig;
    }
    /** @inheritdoc */
    canSign(key) {
        return true;
    }
    /**
     * Sign this transaction
     *
     * @param {KeyPair} signer key
     */
    sign(signer) {
        if (!this._suiTransaction) {
            throw new sdk_core_1.InvalidTransactionError('empty transaction to sign');
        }
        const intentMessage = this.signablePayload;
        const signature = signer.signMessageinUint8Array(intentMessage);
        this.setSerializedSig({ pub: signer.getKeys().pub }, buffer_1.Buffer.from(signature));
        this.addSignature({ pub: signer.getKeys().pub }, buffer_1.Buffer.from(signature));
    }
    /** @inheritdoc */
    toBroadcastFormat() {
        if (!this._suiTransaction) {
            throw new sdk_core_1.InvalidTransactionError('Empty transaction');
        }
        return this.serialize();
    }
    /**
     * Set the transaction type.
     *
     * @param {TransactionType} transactionType The transaction type to be set.
     */
    transactionType(transactionType) {
        this._type = transactionType;
    }
    getDataBytes() {
        const txData = this.getTxData();
        const txSer = builder_1.builder.ser('TransactionData', { V1: txData }, { maxSize: TransactionDataBlock_1.TRANSACTION_DATA_MAX_SIZE });
        return txSer.toBytes();
    }
    /** @inheritDoc */
    get signablePayload() {
        const dataBytes = this.getDataBytes();
        const intentMessage = this.messageWithIntent(utils_1.IntentScope.TransactionData, dataBytes);
        return buffer_1.Buffer.from((0, blake2b_1.default)(32).update(intentMessage).digest('binary'));
    }
    messageWithIntent(scope, message) {
        const intent = this.intentWithScope(scope);
        const intentMessage = new Uint8Array(intent.length + message.length);
        intentMessage.set(intent);
        intentMessage.set(message, intent.length);
        return intentMessage;
    }
    intentWithScope(scope) {
        return [scope, utils_1.IntentVersion.V0, utils_1.AppId.Sui];
    }
    serialize() {
        const dataBytes = this.getDataBytes();
        this._id = bs58_1.default.encode((0, hash_1.hashTypedData)('TransactionData', dataBytes));
        return (0, bcs_1.toB64)(dataBytes);
    }
    static deserializeSuiTransaction(serializedTx) {
        const data = (0, bcs_1.fromB64)(serializedTx);
        const transactionBlock = TransactionDataBlock_1.TransactionBlockDataBuilder.fromBytes(data);
        const inputs = transactionBlock.inputs.map((txInput) => txInput.value);
        const transactions = transactionBlock.transactions;
        const txType = this.getSuiTransactionType(transactions);
        return {
            id: transactionBlock.getDigest(),
            type: txType,
            sender: (0, types_1.normalizeSuiAddress)(transactionBlock.sender),
            tx: {
                inputs: inputs,
                transactions: transactions,
            },
            gasData: {
                payment: this.normalizeCoins(transactionBlock.gasConfig.payment),
                owner: (0, types_1.normalizeSuiAddress)(transactionBlock.gasConfig.owner),
                price: Number(transactionBlock.gasConfig.price),
                budget: Number(transactionBlock.gasConfig.budget),
            },
        };
    }
    static getSuiTransactionType(transactions) {
        // tricky to determine custom tx purely from a serialized tx, we can rely on following logic
        if (transactions.length == 1) {
            return utils_1.default.getSuiTransactionType(transactions[0]);
        }
        if (transactions.some((tx) => utils_1.default.getSuiTransactionType(tx) === iface_1.SuiTransactionType.AddStake)) {
            return iface_1.SuiTransactionType.AddStake;
        }
        if (transactions.some((tx) => utils_1.default.getSuiTransactionType(tx) === iface_1.SuiTransactionType.WithdrawStake)) {
            return iface_1.SuiTransactionType.WithdrawStake;
        }
        if (transactions.some((tx) => utils_1.default.getSuiTransactionType(tx) === iface_1.SuiTransactionType.TokenTransfer)) {
            return iface_1.SuiTransactionType.TokenTransfer;
        }
        if (transactions.every((tx) => utils_1.default.getSuiTransactionType(tx) === iface_1.SuiTransactionType.Transfer)) {
            return iface_1.SuiTransactionType.Transfer;
        }
        return iface_1.SuiTransactionType.CustomTx;
    }
    static getProperGasData(k) {
        return {
            payment: [this.normalizeSuiObjectRef(k.gasData.payment)],
            owner: utils_1.default.normalizeHexId(k.gasData.owner),
            price: Number(k.gasData.price),
            budget: Number(k.gasData.budget),
        };
    }
    static normalizeCoins(coins) {
        return coins.map((coin) => {
            return this.normalizeSuiObjectRef(coin);
        });
    }
    static normalizeSuiObjectRef(obj) {
        return {
            objectId: (0, types_1.normalizeSuiObjectId)(obj.objectId),
            version: Number(obj.version),
            digest: obj.digest,
        };
    }
    /**
     * When building transactions with > 255 input gas payment objects, we first use MergeCoins Tranasactions to merge the
     * additional inputs into the gas coin & slice them from the payment in gasData. When initializing the builder using
     * decoded tx data, we need to get these inputs from MergeCoins & add them back to the gas payment to be able to
     * rebuild from a raw transaction.
     */
    getInputGasPaymentObjectsFromTx(tx) {
        const txInputs = tx.inputs;
        const transactions = tx.transactions;
        const inputGasPaymentObjects = [];
        transactions.forEach((transaction) => {
            if (transaction.kind === 'MergeCoins') {
                const { destination, sources } = transaction;
                if (destination.kind === 'GasCoin') {
                    sources.forEach((source) => {
                        if (source.kind === 'Input') {
                            let input = txInputs[source.index];
                            if ('value' in input) {
                                input = input.value;
                            }
                            if ('Object' in input && (0, utils_1.isImmOrOwnedObj)(input.Object)) {
                                inputGasPaymentObjects.push(input.Object.ImmOrOwned);
                            }
                        }
                    });
                }
            }
        });
        return inputGasPaymentObjects;
    }
}
exports.Transaction = Transaction;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNhY3Rpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvbGliL3RyYW5zYWN0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsOENBT3lCO0FBQ3pCLG1DQUFpRztBQUVqRyxpREFBNEY7QUFDNUYsNkNBQXFHO0FBQ3JHLDJDQUFxRDtBQUNyRCxtQ0FBZ0M7QUFDaEMscUNBQTZDO0FBQzdDLGdEQUF3QjtBQUV4QixtRkFBa0g7QUFDbEgsaURBQXNGO0FBQ3RGLDZEQUFxQztBQUNyQyx3REFBOEQ7QUFFOUQsTUFBc0IsV0FBZSxTQUFRLDBCQUFlO0lBSzFELFlBQXNCLFdBQWlDO1FBQ3JELEtBQUssQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUNyQixDQUFDO0lBRUQsSUFBSSxjQUFjO1FBQ2hCLE9BQU8sSUFBSSxDQUFDLGVBQWUsQ0FBQztJQUM5QixDQUFDO0lBRUQsaUJBQWlCLENBQUMsRUFBcUI7UUFDckMsSUFBSSxDQUFDLGVBQWUsR0FBRyxFQUFFLENBQUM7SUFDNUIsQ0FBQztJQUVELG1CQUFtQjtJQUNuQixJQUFJLEVBQUU7UUFDSixNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDdEMsTUFBTSxJQUFJLEdBQUcsSUFBQSxvQkFBYSxFQUFDLGlCQUFpQixFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQ3pELElBQUksQ0FBQyxHQUFHLEdBQUcsY0FBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM3QixPQUFPLElBQUksQ0FBQyxHQUFHLENBQUM7SUFDbEIsQ0FBQztJQUVELFlBQVksQ0FBQyxTQUF3QixFQUFFLFNBQWlCO1FBQ3RELElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUNqRCxJQUFJLENBQUMsVUFBVSxHQUFHLEVBQUUs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QUksSUFBQSx1QkFBZSxFQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsRUFBRTtnQ0FDdEQsc0JBQXNCLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUM7NkJBQ3REO3lCQUNGO29CQUNILENBQUMsQ0FBQyxDQUFDO2lCQUNKO2FBQ0Y7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUVILE9BQU8sc0JBQXNCLENBQUM7SUFDaEMsQ0FBQztDQUNGO0FBOU9ELGtDQThPQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEJhc2VLZXksXG4gIEJhc2VUcmFuc2FjdGlvbixcbiAgSW52YWxpZFRyYW5zYWN0aW9uRXJyb3IsXG4gIFB1YmxpY0tleSBhcyBCYXNlUHVibGljS2V5LFxuICBTaWduYXR1cmUsXG4gIFRyYW5zYWN0aW9uVHlwZSBhcyBCaXRHb1RyYW5zYWN0aW9uVHlwZSxcbn0gZnJvbSAnQGJpdGdvL3Nkay1jb3JlJztcbmltcG9ydCB7IFN1aVByb2dyYW1tYWJsZVRyYW5zYWN0aW9uLCBTdWlUcmFuc2FjdGlvbiwgU3VpVHJhbnNhY3Rpb25UeXBlLCBUeERhdGEgfSBmcm9tICcuL2lmYWNlJztcbmltcG9ydCB7IEJhc2VDb2luIGFzIENvaW5Db25maWcgfSBmcm9tICdAYml0Z28vc3RhdGljcyc7XG5pbXBvcnQgdXRpbHMsIHsgQXBwSWQsIEludGVudCwgSW50ZW50U2NvcGUsIEludGVudFZlcnNpb24sIGlzSW1tT3JPd25lZE9iaiB9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IHsgR2FzRGF0YSwgbm9ybWFsaXplU3VpQWRkcmVzcywgbm9ybWFsaXplU3VpT2JqZWN0SWQsIFN1aU9iamVjdFJlZiB9IGZyb20gJy4vbXlzdGVubGFiL3R5cGVzJztcbmltcG9ydCB7IFNJR05BVFVSRV9TQ0hFTUVfQllURVMgfSBmcm9tICcuL2NvbnN0YW50cyc7XG5pbXBvcnQgeyBCdWZmZXIgfSBmcm9tICdidWZmZXInO1xuaW1wb3J0IHsgZnJvbUI2NCwgdG9CNjQgfSBmcm9tICdAbXlzdGVuL2Jjcyc7XG5pbXBvcnQgYnM1OCBmcm9tICdiczU4JztcbmltcG9ydCB7IEtleVBhaXIgfSBmcm9tICcuL2tleVBhaXInO1xuaW1wb3J0IHsgVFJBTlNBQ1RJT05fREFUQV9NQVhfU0laRSwgVHJhbnNhY3Rpb25CbG9ja0RhdGFCdWlsZGVyIH0gZnJvbSAnLi9teXN0ZW5sYWIvYnVpbGRlci9UcmFuc2FjdGlvbkRhdGFCbG9jayc7XG5pbXBvcnQgeyBidWlsZGVyLCBNZXJnZUNvaW5zVHJhbnNhY3Rpb24sIFRyYW5zYWN0aW9uVHlwZSB9IGZyb20gJy4vbXlzdGVubGFiL2J1aWxkZXInO1xuaW1wb3J0IGJsYWtlMmIgZnJvbSAnQGJpdGdvL2JsYWtlMmInO1xuaW1wb3J0IHsgaGFzaFR5cGVkRGF0YSB9IGZyb20gJy4vbXlzdGVubGFiL2NyeXB0b2dyYXBoeS9oYXNoJztcblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIFRyYW5zYWN0aW9uPFQ+IGV4dGVuZHMgQmFzZVRyYW5zYWN0aW9uIHtcbiAgcHJvdGVjdGVkIF9zdWlUcmFuc2FjdGlvbjogU3VpVHJhbnNhY3Rpb248VD47XG4gIHByb3RlY3RlZCBfc2lnbmF0dXJlOiBTaWduYXR1cmU7XG4gIHByaXZhdGUgX3NlcmlhbGl6ZWRTaWc6IFVpbnQ4QXJyYXk7XG5cbiAgcHJvdGVjdGVkIGNvbnN0cnVjdG9yKF9jb2luQ29uZmlnOiBSZWFkb25seTxDb2luQ29uZmlnPikge1xuICAgIHN1cGVyKF9jb2luQ29uZmlnKTtcbiAgfVxuXG4gIGdldCBzdWlUcmFuc2FjdGlvbigpOiBTdWlUcmFuc2FjdGlvbjxUPiB7XG4gICAgcmV0dXJuIHRoaXMuX3N1aVRyYW5zYWN0aW9uO1xuICB9XG5cbiAgc2V0U3VpVHJhbnNhY3Rpb24odHg6IFN1aVRyYW5zYWN0aW9uPFQ+KTogdm9pZCB7XG4gICAgdGhpcy5fc3VpVHJhbnNhY3Rpb24gPSB0eDtcbiAgfVxuXG4gIC8qKiBAaW5oZXJpdERvYyAqKi9cbiAgZ2V0IGlkKCk6IHN0cmluZyB7XG4gICAgY29uc3QgZGF0YUJ5dGVzID0gdGhpcy5nZXREYXRhQnl0ZXMoKTtcbiAgICBjb25zdCBoYXNoID0gaGFzaFR5cGVkRGF0YSgnVHJhbnNhY3Rpb25EYXRhJywgZGF0YUJ5dGVzKTtcbiAgICB0aGlzLl9pZCA9IGJzNTguZW5jb2RlKGhhc2gpO1xuICAgIHJldHVybiB0aGlzLl9pZDtcbiAgfVxuXG4gIGFkZFNpZ25hdHVyZShwdWJsaWNLZXk6IEJhc2VQdWJsaWNLZXksIHNpZ25hdHVyZTogQnVmZmVyKTogdm9pZCB7XG4gICAgdGhpcy5fc2lnbmF0dXJlcy5wdXNoKHNpZ25hdHVyZS50b1N0cmluZygnaGV4JykpO1xuICAgIHRoaXMuX3NpZ25hdHVyZSA9IHsgcHVibGljS2V5LCBzaWduYXR1cmUgfTtcbiAgICB0aGlzLnNlcmlhbGl6ZSgpO1xuICB9XG5cbiAgZ2V0IHN1aVNpZ25hdHVyZSgpOiBTaWduYXR1cmUge1xuICAgIHJldHVybiB0aGlzLl9zaWduYXR1cmU7XG4gIH1cblxuICBnZXQgc2VyaWFsaXplZFNpZygpOiBVaW50OEFycmF5IHtcbiAgICByZXR1cm4gdGhpcy5fc2VyaWFsaXplZFNpZztcbiAgfVxuXG4gIHNldFNlcmlhbGl6ZWRTaWcocHVibGljS2V5OiBCYXNlUHVibGljS2V5LCBzaWduYXR1cmU6IEJ1ZmZlcik6IHZvaWQge1xuICAgIGNvbnN0IHB1YktleSA9IEJ1ZmZlci5mcm9tKHB1YmxpY0tleS5wdWIsICdoZXgnKTtcbiAgICBjb25zdCBzZXJpYWxpemVkX3NpZyA9IG5ldyBVaW50OEFycmF5KDEgKyBzaWduYXR1cmUubGVuZ3RoICsgcHViS2V5Lmxlbmd0aCk7XG4gICAgc2VyaWFsaXplZF9zaWcuc2V0KFNJR05BVFVSRV9TQ0hFTUVfQllURVMpO1xuICAgIHNlcmlhbGl6ZWRfc2lnLnNldChzaWduYXR1cmUsIDEpO1xuICAgIHNlcmlhbGl6ZWRfc2lnLnNldChwdWJLZXksIDEgKyBzaWduYXR1cmUubGVuZ3RoKTtcbiAgICB0aGlzLl9zZXJpYWxpemVkU2lnID0gc2VyaWFsaXplZF9zaWc7XG4gIH1cblxuICAvKiogQGluaGVyaXRkb2MgKi9cbiAgY2FuU2lnbihrZXk6IEJhc2VLZXkpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTaWduIHRoaXMgdHJhbnNhY3Rpb25cbiAgICpcbiAgICogQHBhcmFtIHtLZXlQYWlyfSBzaWduZXIga2V5XG4gICAqL1xuXG4gIHNpZ24oc2lnbmVyOiBLZXlQYWlyKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLl9zdWlUcmFuc2FjdGlvbikge1xuICAgICAgdGhyb3cgbmV3IEludmFsaWRUcmFuc2FjdGlvbkVycm9yKCdlbXB0eSB0cmFuc2FjdGlvbiB0byBzaWduJyk7XG4gICAgfVxuXG4gICAgY29uc3QgaW50ZW50TWVzc2FnZSA9IHRoaXMuc2lnbmFibGVQYXlsb2FkO1xuICAgIGNvbnN0IHNpZ25hdHVyZSA9IHNpZ25lci5zaWduTWVzc2FnZWluVWludDhBcnJheShpbnRlbnRNZXNzYWdlKTtcblxuICAgIHRoaXMuc2V0U2VyaWFsaXplZFNpZyh7IHB1Yjogc2lnbmVyLmdldEtleXMoKS5wdWIgfSwgQnVmZmVyLmZyb20oc2lnbmF0dXJlKSk7XG4gICAgdGhpcy5hZGRTaWduYXR1cmUoeyBwdWI6IHNpZ25lci5nZXRLZXlzKCkucHViIH0sIEJ1ZmZlci5mcm9tKHNpZ25hdHVyZSkpO1xuICB9XG5cbiAgLyoqIEBpbmhlcml0ZG9jICovXG4gIHRvQnJvYWRjYXN0Rm9ybWF0KCk6IHN0cmluZyB7XG4gICAgaWYgKCF0aGlzLl9zdWlUcmFuc2FjdGlvbikge1xuICAgICAgdGhyb3cgbmV3IEludmFsaWRUcmFuc2FjdGlvbkVycm9yKCdFbXB0eSB0cmFuc2FjdGlvbicpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5zZXJpYWxpemUoKTtcbiAgfVxuXG4gIC8qKiBAaW5oZXJpdGRvYyAqL1xuICBhYnN0cmFjdCB0b0pzb24oKTogVHhEYXRhO1xuXG4gIC8qKlxuICAgKiBTZXQgdGhlIHRyYW5zYWN0aW9uIHR5cGUuXG4gICAqXG4gICAqIEBwYXJhbSB7VHJhbnNhY3Rpb25UeXBlfSB0cmFuc2FjdGlvblR5cGUgVGhlIHRyYW5zYWN0aW9uIHR5cGUgdG8gYmUgc2V0LlxuICAgKi9cbiAgdHJhbnNhY3Rpb25UeXBlKHRyYW5zYWN0aW9uVHlwZTogQml0R29UcmFuc2FjdGlvblR5cGUpOiB2b2lkIHtcbiAgICB0aGlzLl90eXBlID0gdHJhbnNhY3Rpb25UeXBlO1xuICB9XG5cbiAgLyoqXG4gICAqICBnZXQgdGhlIGNvcnJlY3QgdHhEYXRhIHdpdGggdHJhbnNhY3Rpb24gdHlwZVxuICAgKi9cbiAgYWJzdHJhY3QgZ2V0VHhEYXRhKCk6IFR4RGF0YTtcblxuICAvKipcbiAgICogTG9hZCB0aGUgaW5wdXQgYW5kIG91dHB1dCBkYXRhIG9uIHRoaXMgdHJhbnNhY3Rpb24uXG4gICAqL1xuICBhYnN0cmFjdCBsb2FkSW5wdXRzQW5kT3V0cHV0cygpOiB2b2lkO1xuXG4gIC8qKlxuICAgKiBTZXRzIHRoaXMgdHJhbnNhY3Rpb24gcGF5bG9hZFxuICAgKlxuICAgKiBAcGFyYW0gcmF3VHJhbnNhY3Rpb25cbiAgICovXG4gIGFic3RyYWN0IGZyb21SYXdUcmFuc2FjdGlvbihyYXdUcmFuc2FjdGlvbjogc3RyaW5nKTogdm9pZDtcblxuICBnZXREYXRhQnl0ZXMoKTogVWludDhBcnJheSB7XG4gICAgY29uc3QgdHhEYXRhID0gdGhpcy5nZXRUeERhdGEoKTtcbiAgICBjb25zdCB0eFNlciA9IGJ1aWxkZXIuc2VyKCdUcmFuc2FjdGlvbkRhdGEnLCB7IFYxOiB0eERhdGEgfSwgeyBtYXhTaXplOiBUUkFOU0FDVElPTl9EQVRBX01BWF9TSVpFIH0pO1xuICAgIHJldHVybiB0eFNlci50b0J5dGVzKCk7XG4gIH1cblxuICAvKiogQGluaGVyaXREb2MgKi9cbiAgZ2V0IHNpZ25hYmxlUGF5bG9hZCgpOiBCdWZmZXIge1xuICAgIGNvbnN0IGRhdGFCeXRlcyA9IHRoaXMuZ2V0RGF0YUJ5dGVzKCk7XG4gICAgY29uc3QgaW50ZW50TWVzc2FnZSA9IHRoaXMubWVzc2FnZVdpdGhJbnRlbnQoSW50ZW50U2NvcGUuVHJhbnNhY3Rpb25EYXRhLCBkYXRhQnl0ZXMpO1xuICAgIHJldHVybiBCdWZmZXIuZnJvbShibGFrZTJiKDMyKS51cGRhdGUoaW50ZW50TWVzc2FnZSkuZGlnZXN0KCdiaW5hcnknKSk7XG4gIH1cblxuICBwcml2YXRlIG1lc3NhZ2VXaXRoSW50ZW50KHNjb3BlOiBJbnRlbnRTY29wZSwgbWVzc2FnZTogVWludDhBcnJheSkge1xuICAgIGNvbnN0IGludGVudCA9IHRoaXMuaW50ZW50V2l0aFNjb3BlKHNjb3BlKTtcbiAgICBjb25zdCBpbnRlbnRNZXNzYWdlID0gbmV3IFVpbnQ4QXJyYXkoaW50ZW50Lmxlbmd0aCArIG1lc3NhZ2UubGVuZ3RoKTtcbiAgICBpbnRlbnRNZXNzYWdlLnNldChpbnRlbnQpO1xuICAgIGludGVudE1lc3NhZ2Uuc2V0KG1lc3NhZ2UsIGludGVudC5sZW5ndGgpO1xuICAgIHJldHVybiBpbnRlbnRNZXNzYWdlO1xuICB9XG5cbiAgcHJpdmF0ZSBpbnRlbnRXaXRoU2NvcGUoc2NvcGU6IEludGVudFNjb3BlKTogSW50ZW50IHtcbiAgICByZXR1cm4gW3Njb3BlLCBJbnRlbnRWZXJzaW9uLlYwLCBBcHBJZC5TdWldO1xuICB9XG5cbiAgc2VyaWFsaXplKCk6IHN0cmluZyB7XG4gICAgY29uc3QgZGF0YUJ5dGVzID0gdGhpcy5nZXREYXRhQnl0ZXMoKTtcbiAgICB0aGlzLl9pZCA9IGJzNTguZW5jb2RlKGhhc2hUeXBlZERhdGEoJ1RyYW5zYWN0aW9uRGF0YScsIGRhdGFCeXRlcykpO1xuICAgIHJldHVybiB0b0I2NChkYXRhQnl0ZXMpO1xuICB9XG5cbiAgc3RhdGljIGRlc2VyaWFsaXplU3VpVHJhbnNhY3Rpb24oc2VyaWFsaXplZFR4OiBzdHJpbmcpOiBTdWlUcmFuc2FjdGlvbjxTdWlQcm9ncmFtbWFibGVUcmFuc2FjdGlvbj4ge1xuICAgIGNvbnN0IGRhdGEgPSBmcm9tQjY0KHNlcmlhbGl6ZWRUeCk7XG4gICAgY29uc3QgdHJhbnNhY3Rpb25CbG9jayA9IFRyYW5zYWN0aW9uQmxvY2tEYXRhQnVpbGRlci5mcm9tQnl0ZXMoZGF0YSk7XG4gICAgY29uc3QgaW5wdXRzID0gdHJhbnNhY3Rpb25CbG9jay5pbnB1dHMubWFwKCh0eElucHV0KSA9PiB0eElucHV0LnZhbHVlKTtcbiAgICBjb25zdCB0cmFuc2FjdGlvbnMgPSB0cmFuc2FjdGlvbkJsb2NrLnRyYW5zYWN0aW9ucztcbiAgICBjb25zdCB0eFR5cGUgPSB0aGlzLmdldFN1aVRyYW5zYWN0aW9uVHlwZSh0cmFuc2FjdGlvbnMpO1xuICAgIHJldHVybiB7XG4gICAgICBpZDogdHJhbnNhY3Rpb25CbG9jay5nZXREaWdlc3QoKSxcbiAgICAgIHR5cGU6IHR4VHlwZSxcbiAgICAgIHNlbmRlcjogbm9ybWFsaXplU3VpQWRkcmVzcyh0cmFuc2FjdGlvbkJsb2NrLnNlbmRlciEpLFxuICAgICAgdHg6IHtcbiAgICAgICAgaW5wdXRzOiBpbnB1dHMsXG4gICAgICAgIHRyYW5zYWN0aW9uczogdHJhbnNhY3Rpb25zLFxuICAgICAgfSxcbiAgICAgIGdhc0RhdGE6IHtcbiAgICAgICAgcGF5bWVudDogdGhpcy5ub3JtYWxpemVDb2lucyh0cmFuc2FjdGlvbkJsb2NrLmdhc0NvbmZpZy5wYXltZW50ISksXG4gICAgICAgIG93bmVyOiBub3JtYWxpemVTdWlBZGRyZXNzKHRyYW5zYWN0aW9uQmxvY2suZ2FzQ29uZmlnLm93bmVyISksXG4gICAgICAgIHByaWNlOiBOdW1iZXIodHJhbnNhY3Rpb25CbG9jay5nYXNDb25maWcucHJpY2UgYXMgc3RyaW5nKSxcbiAgICAgICAgYnVkZ2V0OiBOdW1iZXIodHJhbnNhY3Rpb25CbG9jay5nYXNDb25maWcuYnVkZ2V0IGFzIHN0cmluZyksXG4gICAgICB9LFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBnZXRTdWlUcmFuc2FjdGlvblR5cGUodHJhbnNhY3Rpb25zOiBUcmFuc2FjdGlvblR5cGVbXSk6IFN1aVRyYW5zYWN0aW9uVHlwZSB7XG4gICAgLy8gdHJpY2t5IHRvIGRldGVybWluZSBjdXN0b20gdHggcHVyZWx5IGZyb20gYSBzZXJpYWxpemVkIHR4LCB3ZSBjYW4gcmVseSBvbiBmb2xsb3dpbmcgbG9naWNcbiAgICBpZiAodHJhbnNhY3Rpb25zLmxlbmd0aCA9PSAxKSB7XG4gICAgICByZXR1cm4gdXRpbHMuZ2V0U3VpVHJhbnNhY3Rpb25UeXBlKHRyYW5zYWN0aW9uc1swXSk7XG4gICAgfVxuICAgIGlmICh0cmFuc2FjdGlvbnMuc29tZSgodHgpID0+IHV0aWxzLmdldFN1aVRyYW5zYWN0aW9uVHlwZSh0eCkgPT09IFN1aVRyYW5zYWN0aW9uVHlwZS5BZGRTdGFrZSkpIHtcbiAgICAgIHJldHVybiBTdWlUcmFuc2FjdGlvblR5cGUuQWRkU3Rha2U7XG4gICAgfVxuICAgIGlmICh0cmFuc2FjdGlvbnMuc29tZSgodHgpID0+IHV0aWxzLmdldFN1aVRyYW5zYWN0aW9uVHlwZSh0eCkgPT09IFN1aVRyYW5zYWN0aW9uVHlwZS5XaXRoZHJhd1N0YWtlKSkge1xuICAgICAgcmV0dXJuIFN1aVRyYW5zYWN0aW9uVHlwZS5XaXRoZHJhd1N0YWtlO1xuICAgIH1cbiAgICBpZiAodHJhbnNhY3Rpb25zLnNvbWUoKHR4KSA9PiB1dGlscy5nZXRTdWlUcmFuc2FjdGlvblR5cGUodHgpID09PSBTdWlUcmFuc2FjdGlvblR5cGUuVG9rZW5UcmFuc2ZlcikpIHtcbiAgICAgIHJldHVybiBTdWlUcmFuc2FjdGlvblR5cGUuVG9rZW5UcmFuc2ZlcjtcbiAgICB9XG4gICAgaWYgKHRyYW5zYWN0aW9ucy5ldmVyeSgodHgpID0+IHV0aWxzLmdldFN1aVRyYW5zYWN0aW9uVHlwZSh0eCkgPT09IFN1aVRyYW5zYWN0aW9uVHlwZS5UcmFuc2ZlcikpIHtcbiAgICAgIHJldHVybiBTdWlUcmFuc2FjdGlvblR5cGUuVHJhbnNmZXI7XG4gICAgfVxuXG4gICAgcmV0dXJuIFN1aVRyYW5zYWN0aW9uVHlwZS5DdXN0b21UeDtcbiAgfVxuXG4gIHN0YXRpYyBnZXRQcm9wZXJHYXNEYXRhKGs6IGFueSk6IEdhc0RhdGEge1xuICAgIHJldHVybiB7XG4gICAgICBwYXltZW50OiBbdGhpcy5ub3JtYWxpemVTdWlPYmplY3RSZWYoay5nYXNEYXRhLnBheW1lbnQpXSxcbiAgICAgIG93bmVyOiB1dGlscy5ub3JtYWxpemVIZXhJZChrLmdhc0RhdGEub3duZXIpLFxuICAgICAgcHJpY2U6IE51bWJlcihrLmdhc0RhdGEucHJpY2UpLFxuICAgICAgYnVkZ2V0OiBOdW1iZXIoay5nYXNEYXRhLmJ1ZGdldCksXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIG5vcm1hbGl6ZUNvaW5zKGNvaW5zOiBhbnlbXSk6IFN1aU9iamVjdFJlZltdIHtcbiAgICByZXR1cm4gY29pbnMubWFwKChjb2luKSA9PiB7XG4gICAgICByZXR1cm4gdGhpcy5ub3JtYWxpemVTdWlPYmplY3RSZWYoY29pbik7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBub3JtYWxpemVTdWlPYmplY3RSZWYob2JqOiBTdWlPYmplY3RSZWYpOiBTdWlPYmplY3RSZWYge1xuICAgIHJldHVybiB7XG4gICAgICBvYmplY3RJZDogbm9ybWFsaXplU3VpT2JqZWN0SWQob2JqLm9iamVjdElkKSxcbiAgICAgIHZlcnNpb246IE51bWJlcihvYmoudmVyc2lvbiksXG4gICAgICBkaWdlc3Q6IG9iai5kaWdlc3QsXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBXaGVuIGJ1aWxkaW5nIHRyYW5zYWN0aW9ucyB3aXRoID4gMjU1IGlucHV0IGdhcyBwYXltZW50IG9iamVjdHMsIHdlIGZpcnN0IHVzZSBNZXJnZUNvaW5zIFRyYW5hc2FjdGlvbnMgdG8gbWVyZ2UgdGhlXG4gICAqIGFkZGl0aW9uYWwgaW5wdXRzIGludG8gdGhlIGdhcyBjb2luICYgc2xpY2UgdGhlbSBmcm9tIHRoZSBwYXltZW50IGluIGdhc0RhdGEuIFdoZW4gaW5pdGlhbGl6aW5nIHRoZSBidWlsZGVyIHVzaW5nXG4gICAqIGRlY29kZWQgdHggZGF0YSwgd2UgbmVlZCB0byBnZXQgdGhlc2UgaW5wdXRzIGZyb20gTWVyZ2VDb2lucyAmIGFkZCB0aGVtIGJhY2sgdG8gdGhlIGdhcyBwYXltZW50IHRvIGJlIGFibGUgdG9cbiAgICogcmVidWlsZCBmcm9tIGEgcmF3IHRyYW5zYWN0aW9uLlxuICAgKi9cbiAgcHJvdGVjdGVkIGdldElucHV0R2FzUGF5bWVudE9iamVjdHNGcm9tVHgodHg6IFN1aVByb2dyYW1tYWJsZVRyYW5zYWN0aW9uKTogU3VpT2JqZWN0UmVmW10ge1xuICAgIGNvbnN0IHR4SW5wdXRzID0gdHguaW5wdXRzO1xuICAgIGNvbnN0IHRyYW5zYWN0aW9ucyA9IHR4LnRyYW5zYWN0aW9ucztcbiAgICBjb25zdCBpbnB1dEdhc1BheW1lbnRPYmplY3RzOiBTdWlPYmplY3RSZWZbXSA9IFtdO1xuXG4gICAgdHJhbnNhY3Rpb25zLmZvckVhY2goKHRyYW5zYWN0aW9uKSA9PiB7XG4gICAgICBpZiAodHJhbnNhY3Rpb24ua2luZCA9PT0gJ01lcmdlQ29pbnMnKSB7XG4gICAgICAgIGNvbnN0IHsgZGVzdGluYXRpb24sIHNvdXJjZXMgfSA9IHRyYW5zYWN0aW9uIGFzIE1lcmdlQ29pbnNUcmFuc2FjdGlvbjtcbiAgICAgICAgaWYgKGRlc3RpbmF0aW9uLmtpbmQgPT09ICdHYXNDb2luJykge1xuICAgICAgICAgIHNvdXJjZXMuZm9yRWFjaCgoc291cmNlKSA9PiB7XG4gICAgICAgICAgICBpZiAoc291cmNlLmtpbmQgPT09ICdJbnB1dCcpIHtcbiAgICAgICAgICAgICAgbGV0IGlucHV0ID0gdHhJbnB1dHNbc291cmNlLmluZGV4XTtcbiAgICAgICAgICAgICAgaWYgKCd2YWx1ZScgaW4gaW5wdXQpIHtcbiAgICAgICAgICAgICAgICBpbnB1dCA9IGlucHV0LnZhbHVlO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGlmICgnT2JqZWN0JyBpbiBpbnB1dCAmJiBpc0ltbU9yT3duZWRPYmooaW5wdXQuT2JqZWN0KSkge1xuICAgICAgICAgICAgICAgIGlucHV0R2FzUGF5bWVudE9iamVjdHMucHVzaChpbnB1dC5PYmplY3QuSW1tT3JPd25lZCk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGlucHV0R2FzUGF5bWVudE9iamVjdHM7XG4gIH1cbn1cbiJdfQ==